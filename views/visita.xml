<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    
    <record id="action_visita" model="ir.actions.act_window">
        <field name="name">visita</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">gestion_visitas.visita</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="context">{'search_default_today_and_current_rutero':1}</field>
        <field name="view_id" ref="view_tree_visita"/>
    </record>

    <record id="view_calendar_visita" model="ir.ui.view">
        <field name="name">gestion_visitas.visita.calendar</field>
        <field name="model">gestion_visitas.visita</field>
        <field name="arch" type="xml">
            <calendar string="Calendario de visitas" date_start="hora_programada"
                      event_open_popup="0" create="0" color="contact_id">
                <field name="rutero_id"/>
                <field name="hora_programada"/>
                <field name="estado"/>
                <field name="contact_id"/>
            </calendar>
        </field>
    </record>

    <record id="view_search_visitas" model="ir.ui.view">
        <field name="name">Vista Search View</field>
        <field name="model">gestion_visitas.visita</field>
        <field name="arch" type="xml">
            <search>
                <field name="rutero_id"/>
                <field name="contact_id"/>
                <filter string="Mis visitas del dia" name="today_and_current_rutero"
                        domain="[('rutero_id', '=', uid), ('hora_programada', '&gt;=', context_today().strftime('%%Y-%%m-%%d 00:00:00')), ('hora_programada', '&lt;=', context_today().strftime('%%Y-%%m-%%d 23:59:59'))]"/>
            </search>
        </field>
    </record>

    <record id="view_tree_visita" model="ir.ui.view">
        <field name="name">gestion_visitas.visita.tree</field>
        <field name="model">gestion_visitas.visita</field>
        <field name="arch" type="xml">
            <tree default_order='hora_programada' decoration-info="estado == 'finalizado'"
                  decoration-success="estado == 'en curso'">
                <field name="rutero_id"/>
                <field name="contact_id"/>
                <field name="hora_programada"/>
                <field name="estado"/>
            </tree>
        </field>
    </record>

    <record id="view_form_visita" model="ir.ui.view">
        <field name="name">gestion_visitas.visita.form</field>
        <field name="model">gestion_visitas.visita</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group string="Detalles Generales">
                        <field name="estado" readonly="True"/>
                        <field name="contact_id"/>
                        <field name="direccion_contacto"/>
                        <field name="motivo"/>
                        <field name="hora_programada"/>
                        <field name="rutero_id"/>
                    </group>

                    <group string="Resultado De La Visita"
                           invisible="estado == 'sin planificar' or estado == 'planificado'">
                        <field name="hora_inicio_visita" readonly="True"/>
                        <field name="hora_fin_visita" readonly="True"/>

                        <field name="efectiva" invisible="not hora_inicio_visita"
                               readonly="estado == 'finalizado'"/>
                        <field name="razon_no_venta" invisible="efectiva == True"
                               readonly="estado == 'finalizado'"/>
                        <field name="nueva_fecha_programada" invisible="razon_no_venta != 're-agendar'" required="True"/>

                        <field name="descripcion_no_venta"
                               invisible="efectiva == True or razon_no_venta == 're-agendar'" widget="text"
                               readonly="estado == 'finalizado'"
                               required="True"/>

                        <field name="descripcion_motivo_reagendado"
                               widget="text"
                               string="Descripcion de Motivo de Re-Agenda"
                               invisible="efectiva == True or razon_no_venta != 're-agendar'"
                               required="True"/>

                        <field name="visit_images" widget="many2many_binary"
                               invisible="not hora_inicio_visita or razon_no_venta == 're-agendar'"
                               readonly="estado == 'finalizado'"/>
                        <field name="observaciones" widget="text"
                               readonly="estado == 'finalizado'"
                               invisible="razon_no_venta == 're-agendar'"
                               required="estado == 'en curso'"/>รง
                    </group>
                    <button string="Iniciar Visita" class="btn-primary" type="object"
                            name="action_iniciar_visita" invisible="estado != 'planificado'"/>
                    <button string="Terminar Visita" class="btn-danger" type="object"
                            name="action_terminar_visita"
                            invisible="estado != 'en curso'"
                    />

                </sheet>

                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids" options="{'post_refresh': 'recipients'}"/>
                </div>
            </form>
        </field>
    </record>


</odoo>